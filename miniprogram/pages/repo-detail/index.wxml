<view class="container">
  <!-- Skeleton Loading -->
  <block wx:if="{{loading}}">
    <skeleton-loader type="detail" />
  </block>
  
  <block wx:else>
    <custom-nav showBack="{{true}}" />
    
    <!-- Header: Repo Info (Redesigned - Two Column Layout) -->
    <view class="repo-header">
      <!-- Top Row: Name + Edit -->
      <view class="header-top">
         <view class="title-row">
            <text class="name">{{repo.name}}</text>
            <text class="edit-btn" bindtap="goToEdit">✎</text>
        </view>
      </view>

      <!-- Two Column Layout -->
      <view class="header-columns">
        <!-- Left Column: Mileage & Register Date -->
        <view class="header-left">
          <view class="mileage-block">
            <text class="mileage-value">{{repo.current_mileage}}</text>
            <text class="mileage-unit">km</text>
          </view>
          <view class="register-info">
            <view class="info-row">
              <text class="info-label">注册日期：</text>
              <text class="info-val">{{repo.formatted_register_date || '--'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">车龄：</text>
              <text class="info-val">{{repo.vehicle_age}}</text>
            </view>
          </view>
        </view>

        <!-- Divider -->
        <view class="header-divider"></view>

        <!-- Right Column: Insurance & Inspection (Days Left) -->
        <view class="header-right">
          <view class="expiry-item">
            <text class="expiry-label">车检</text>
            <text class="expiry-val {{repo.inspection_warning ? 'warn' : ''}}">{{repo.inspection_days_left}}</text>
          </view>
          <view class="expiry-item">
            <text class="expiry-label">交强险</text>
            <text class="expiry-val {{repo.compulsory_warning ? 'warn' : ''}}">{{repo.compulsory_days_left}}</text>
          </view>
          <view class="expiry-item">
            <text class="expiry-label">商业险</text>
            <text class="expiry-val {{repo.commercial_warning ? 'warn' : ''}}">{{repo.commercial_days_left}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Tab Bar -->
    <view class="tab-bar">
        <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="{{0}}">
            <text>时间线</text>
        </view>
        <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="{{1}}">
            <text>数据统计</text>
        </view>
    </view>

    <!-- Tab 1: Timeline -->
    <view class="tab-content" wx:if="{{currentTab === 0}}">
        <!-- Dashboard Widget (High Priority Alerts) -->
        <dashboard-widget repoId="{{repoId}}"></dashboard-widget>

        <view class="commit-log">
            <view class="log-title">整备记录</view>
            
            <view class="commit-list">
                <view class="commit-item" wx:for="{{commits}}" wx:key="_id">
                <view class="commit-left">
                    <view class="commit-dot"></view>
                    <view class="commit-line"></view>
                </view>
                <view class="commit-content" bindtap="goToCommitDetail" data-id="{{item._id}}">
                    <view class="commit-header">
                    <text class="commit-title">{{item.title}}</text>
                    <text class="commit-miles">{{item.mileage}} km</text>
                    </view>
                    <view class="commit-meta">
                    <text class="commit-id">{{item._id}}</text>
                    <text class="commit-date">{{item.date}}</text>
                    </view>
                </view>
                </view>
                
                <view class="commit-item start-node">
                    <view class="commit-left">
                        <view class="commit-dot outline"></view>
                    </view>
                    <view class="commit-content">
                        <text class="commit-start">车辆档案建立 (Initialized)</text>
                    </view>
                </view>
            </view>
        </view>

        <!-- FAB: Add Commit (Only in Timeline) -->
        <view class="fab-btn" bindtap="goToCommitCreate">+</view>
    </view>

    <!-- Tab 2: Insights -->
    <view class="tab-content" wx:if="{{currentTab === 1}}">
        <insights-view repoId="{{repoId}}"></insights-view>
    </view> 
  </block>
</view>
