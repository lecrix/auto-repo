<view class="insights-container">

  <!-- 1. Key Metrics Cards -->
  <view class="metrics-grid">
    <view class="metric-card main">
      <view class="label">总花费</view>
      <view class="value currency">¥{{stats.total_cost || 0}}</view>
    </view>
    <view class="metric-card">
      <view class="label">行驶里程</view>
      <view class="value">{{stats.driven_mileage || 0}}<text class="unit">km</text></view>
    </view>
    <view class="metric-card">
      <view class="label">每公里成本</view>
      <view class="value">¥{{stats.cost_per_km || 0}}</view>
    </view>
    <view class="metric-card">
      <view class="label">每公里油费</view>
      <view class="value">¥{{stats.fuel_cost_per_km || 0}}</view>
    </view>
  </view>

  <!-- 2. Trend Charts Section -->
  <view class="chart-section" wx:if="{{trends && trends.months && trends.months.length > 0}}">
    <view class="section-title">趋势分析 (最近6个月)</view>
    <wxs module="utils">
    module.exports.getMonthNumber = function(monthStr) {
      if (!monthStr || typeof monthStr !== 'string') return '';
      var parts = monthStr.split('-');
      if (parts.length < 2) return '';
      var month = parseInt(parts[1]);
      return isNaN(month) ? '' : month;
    }
    </wxs>
    <view class="trend-container">
      <!-- Cost Trend -->
      <view class="trend-chart">
        <view class="trend-label">月度花费</view>
        <view class="trend-bars">
          <view class="trend-bar-item" wx:for="{{trends.months}}" wx:key="month">
            <view class="bar-wrapper">
              <view class="bar" style="height: {{item.cost / (trends.maxCost || 1) * 100}}%"></view>
            </view>
            <view class="bar-label">{{utils.getMonthNumber(item.month)}}月</view>
            <view class="bar-value">¥{{item.cost}}</view>
          </view>
        </view>
      </view>

       <!-- Fuel Cost Trend -->
       <view class="trend-chart">
        <view class="trend-label">月度油费</view>
        <view class="trend-bars">
          <view class="trend-bar-item" wx:for="{{trends.months}}" wx:key="month">
            <view class="bar-wrapper">
              <view class="bar fuel" style="height: {{item.fuel_cost / (trends.maxFuelCost || 1) * 100}}%"></view>
            </view>
            <view class="bar-label">{{utils.getMonthNumber(item.month)}}月</view>
            <view class="bar-value">¥{{item.fuel_cost}}</view>
          </view>
        </view>
       </view>

        <!-- Mileage Trend - Removed per user request -->
    </view>
  </view>

  <!-- 3. Cost Composition Charts Section -->
  <view class="chart-section">
    <view class="section-title">费用构成</view>
    <view class="chart-container">
      <!-- TODO: Integrate uCharts here later -->
      <!-- For now, use simple bar list visualization -->
       <view class="simple-chart" wx:if="{{stats.composition && stats.composition.length > 0}}">
          <view class="chart-row" wx:for="{{stats.composition}}" wx:key="name">
             <view class="row-label">{{item.name}}</view>
             <view class="row-bar-area">
                 <view class="row-bar" style="width: {{item.percentage}}%"></view>
             </view>
             <view class="row-val">¥{{item.value}} ({{item.percentage}}%)</view>
          </view>
       </view>
      <view class="empty-state" wx:else>
        暂无数据
      </view>
    </view>
  </view>

  <!-- 3. Upcoming Tasks (Issues) -->
  <view class="chart-section">
    <view class="section-header">
      <view class="section-title">待办事项</view>
      <view class="btn-add-issue" bindtap="goToAddIssue">+ 新建</view>
    </view>

    <view class="issue-list" wx:if="{{issues && issues.length > 0}}">
        <view class="issue-swipe-wrapper" wx:for="{{issues}}" wx:key="_id">
            <movable-area class="movable-area">
                <movable-view 
                    class="movable-view" 
                    direction="horizontal" 
                    x="{{item.x || 0}}"
                    damping="50"
                    friction="5"
                    out-of-bounds="true"
                    bindchange="onSwipeChange"
                    bindtouchend="onSwipeEnd"
                    data-index="{{index}}"
                    data-issue="{{item}}">
                    <view class="issue-item {{item.status === 'closed' ? 'completed' : ''}}" bindtap="onIssueClick" data-issue="{{item}}">
                        <view class="issue-left">
                            <view class="issue-status {{item.status === 'closed' ? 'done' : item.priority}}"></view>
                        </view>
                        <view class="issue-content">
                            <view class="issue-title">{{item.title}}</view>
                            <view class="issue-meta">
                                <text wx:if="{{item.status === 'closed'}}">已完成</text>
                                <text wx:elif="{{item.due_mileage}}">提醒里程: {{item.due_mileage}} km</text>
                                <text wx:elif="{{item.due_date}}">截止日期: {{item.due_date}}</text>
                            </view>
                        </view>
                        <view class="issue-action" catchtap="onActionTap" wx:if="{{item.status !== 'closed'}}">
                            <text class="btn-check" catchtap="onCompleteIssue" data-issue="{{item}}">✓</text>
                        </view>
                        <view class="issue-action" catchtap="onActionTap" wx:else>
                            <text class="btn-reopen" catchtap="onReopenIssue" data-issue="{{item}}">↺</text>
                        </view>
                    </view>
                    <view class="delete-btn" catchtap="onDeleteIssue" data-issue="{{item}}">删除</view>
                </movable-view>
            </movable-area>
        </view>
    </view>

    <view class="empty-state" wx:else>
        暂无待办事项
        <view class="add-hint" bindtap="goToAddIssue">+ 添加提醒</view>
    </view>
  </view>

</view>
