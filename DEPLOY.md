# AutoRepo 极速上线指南 (微信云托管)

本指南将帮助您使用**最低成本**将 AutoRepo 上线，无需购买域名、无需备案、无需配置 HTTPS。

## ✅ 准备工作

您的代码已经针对云托管进行了以下自动化适配：
1. **Docker 配置**: `backend/Dockerfile` 已调整为监听 80 端口，并设置了中国时区。
2. **前端网络**: `miniprogram/services/api.ts` 已升级，支持 `wx.cloud.callContainer` 免鉴权调用。
3. **环境配置**: `miniprogram/config.ts` 已添加 `prod` 模式。

---

## 🚀 部署步骤

### 第一步：开通云托管
1. 打开微信开发者工具，点击工具栏的 **“云开发”** 按钮。
2. 进入 **“云托管”** (Cloud Run) 面板。
3. 如果未开通，请按指引开通（选择按量付费）。

### 第二步：部署后端服务
1. **创建服务**：
   - 服务名称：`backend` (或您喜欢的名字)
   - 允许公网访问：**关闭** (我们要用内网链路，更安全且省钱)
2. **发布版本**：
   - 方式：选择 **“本地代码上传”**
   - 目录：选择项目中的 `backend` 文件夹
   - 端口：`80` (非常重要！)
3. **环境变量** (在服务设置中配置)：
   - `ENVIRONMENT`: `production`
   - `JWT_SECRET`: (必填) 生成一个 32 位以上的随机字符串
   - `WECHAT_APPID`: (必填) 您的微信小程序 AppID
   - `WECHAT_SECRET`: (必填) 您的微信小程序 AppSecret
   - `MONGO_URL`: (选填) 推荐购买云托管配套的 MongoDB；若不填则使用内存版 MockDB (重启数据丢失)

### 第三步：前端发布
1. **检查配置**：
   打开 `miniprogram/config.ts`，确保 `CURRENT_MODE` 为 `'prod'`。
   ```typescript
   const CURRENT_MODE: 'dev' | 'device' | 'prod' = 'prod'
   ```
2. **上传代码**：
   在微信开发者工具右上角点击 **“上传”**。
3. **提交审核**：
   在微信公众平台 (mp.weixin.qq.com) 提交版本审核。

---

## 💰 成本估算

使用微信云托管的按量付费模式：
- **计算资源**：无请求时不扣费（缩容到 0）。小程序冷启动时会自动拉起容器（约 3-5 秒）。
- **数据库**：如果使用云托管 MongoDB，每月有一定免费额度（具体视腾讯云政策）。
- **流量**：按实际使用量计费。
- **域名/证书**：**0 元** (不需要)。

## 🛠 常见问题

**Q: 第一次打开小程序为什么很慢？**
A: 因为设置了“缩容到 0”，没有用户访问时容器会停止。第一个用户访问时需要几秒钟启动容器。可以在云托管设置中配置“最小实例数 1”来避免此问题，但会增加少量成本。

**Q: 图片存哪里了？**
A: 前端代码配置了使用微信云存储 (Cloud Storage)，图片直接传到微信云端，不占用后端容器带宽。
