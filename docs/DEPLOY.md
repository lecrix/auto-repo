# AutoRepo 部署指南 (微信云托管)

本指南帮助您使用**最低成本**将 AutoRepo 上线，无需购买域名、无需备案、无需配置 HTTPS。

---

## 准备工作

代码已针对云托管进行以下自动化适配：

| 组件 | 文件 | 说明 |
|------|------|------|
| Docker | `backend/Dockerfile` | 监听 80 端口，中国时区 |
| 前端网络 | `miniprogram/services/api.ts` | 支持 `wx.cloud.callContainer` 免鉴权调用 |
| 环境配置 | `miniprogram/config.ts` | 已添加 `prod` 模式 |

---

## 部署步骤

### 第一步：开通云托管

1. 打开微信开发者工具，点击工具栏的 **"云开发"** 按钮
2. 进入 **"云托管"** (Cloud Run) 面板
3. 如果未开通，按指引开通（选择按量付费）

### 第二步：部署后端服务

#### 方式 A：GitHub 自动流水线（推荐）

1. **创建服务**：
   - 服务名称：`backend`
   - 允许公网访问：**关闭**

2. **流水线配置**：
   | 配置项 | 值 | 说明 |
   |--------|-----|------|
   | 代码源 | GitHub | 授权并选择仓库 |
   | 仓库 | `auto-repo` | 你的仓库名 |
   | 分支 | `master` | 或 `main` |
   | 代码目录 | `/backend` | ⚠️ **必填！否则构建失败** |
   | Dockerfile 路径 | `Dockerfile` | 默认值 |

3. **环境变量**（在服务设置中配置）：
   | 变量名 | 必填 | 说明 |
   |--------|------|------|
   | `ENVIRONMENT` | 是 | 设为 `production` |
   | `JWT_SECRET` | 是 | 32位以上随机字符串 |
   | `WECHAT_APPID` | 是 | 小程序 AppID |
   | `WECHAT_SECRET` | 是 | 小程序 AppSecret |
   | `MONGO_URL` | 否 | 数据库连接串，不填则使用 MockDB |

#### 方式 B：本地代码上传（备用）

1. 将 `backend` 文件夹内的文件压缩为 zip
2. 发布版本：
   - 方式：选择 **"本地代码上传"**
   - 端口：`80`
   - 环境变量：同上

### 第三步：前端发布

1. **检查配置**：打开 `miniprogram/config.ts`，确保 `CURRENT_MODE` 为 `'prod'`
   ```typescript
   const CURRENT_MODE: 'dev' | 'device' | 'prod' = 'prod'
   ```

2. **上传代码**：在微信开发者工具右上角点击 **"上传"**

3. **提交审核**：在微信公众平台 (mp.weixin.qq.com) 提交版本审核

---

## 成本估算

使用微信云托管的按量付费模式：

| 项目 | 费用 | 说明 |
|------|------|------|
| 计算资源 | 按需 | 无请求时不扣费（缩容到 0），冷启动约 3-5 秒 |
| 数据库 | 按需 | 云托管 MongoDB 每月有免费额度 |
| 流量 | 按需 | 按实际使用量计费 |
| 域名/证书 | **0 元** | 不需要 |

---

## 常见问题

### Q: 第一次打开小程序为什么很慢？

因为设置了"缩容到 0"，没有用户访问时容器会停止。第一个用户访问时需要几秒钟启动容器。

**解决方案**：在云托管设置中配置"最小实例数 1"来避免冷启动，但会增加少量成本。

### Q: 图片存哪里了？

前端代码配置了使用微信云存储 (Cloud Storage)，图片直接传到微信云端，不占用后端容器带宽。

### Q: 如何查看后端日志？

在云托管控制台 → 服务详情 → 日志，可以查看容器运行日志和请求日志。

### Q: 如何更新后端代码？

- **GitHub 流水线**：推送代码到指定分支，自动触发构建部署
- **本地上传**：重新打包上传，发布新版本

---

## 相关文档

- [功能总结](./FEATURE_SUMMARY.md)
- [测试指南](./TESTING_GUIDE.md)
- [开发历史](./WORK_SUMMARY.md)
- [贡献指南](../CONTRIBUTING.md)
