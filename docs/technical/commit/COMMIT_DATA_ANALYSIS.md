# Commit (Maintenance Record) Data Structure & API Analysis

**Last Updated**: 2026-01-27  
**Scope**: Backend models, API endpoints, frontend integration, search/filter/export requirements

---

## 1. COMMIT DATA MODEL SCHEMA

### Pydantic Model Definition (`backend/models.py`)

```python
class Commit(BaseModel):
    id: Optional[str] = Field(alias="_id", default=None)
    repo_id: str
    title: str
    message: Optional[str] = None
    mileage: int
    type: str
    cost: Optional[Cost] = None
    closes_issues: list[str] = []
    timestamp: float = Field(default_factory=lambda: datetime.now().timestamp() * 1000)
```

### Nested Cost Model

```python
class Cost(BaseModel):
    parts: float = 0
    labor: float = 0
    currency: str = "CNY"
```

---

## 2. COMPLETE FIELD REFERENCE

### Field Breakdown with Types & Usage

| Field | Type | Default | Required | Description | Searchable | Filterable | Notes |
|-------|------|---------|----------|-------------|-----------|-----------|-------|
| `id` (alias: `_id`) | `str \| None` | `None` | No | MongoDB ObjectId as string | Yes | No | Generated by DB, returned in responses |
| `repo_id` | `str` | — | **Yes** | Vehicle/Repository ID | Yes | **Yes** | Required: links commit to vehicle |
| `title` | `str` | — | **Yes** | Short maintenance description | **Yes** | No | "更换机油", "刹车片更换", "轮胎平衡" |
| `message` | `str \| None` | `None` | No | Detailed description | **Yes** | No | Long-form notes: parts used, notes |
| `mileage` | `int` | — | **Yes** | Odometer reading (km) | No | **Yes** | Required: immutable once set |
| `type` | `str` | — | **Yes** | Category of work | No | **Yes** | See enum section below |
| `cost.parts` | `float` | `0` | No | Parts/materials cost (CNY) | No | **Yes** | ≥ 0; sum aggregated in stats |
| `cost.labor` | `float` | `0` | No | Labor/service cost (CNY) | No | **Yes** | ≥ 0; sum aggregated in stats |
| `cost.currency` | `str` | `"CNY"` | No | Currency code | No | No | Currently hardcoded to CNY |
| `closes_issues` | `list[str]` | `[]` | No | Issue IDs closed by this commit | No | No | Triggers automation on create |
| `timestamp` | `float` | Current time (ms) | No | Creation time in milliseconds | No | **Yes** | Unix epoch × 1000; auto-set |

---

## 3. TYPE ENUM VALUES

### Valid Type Values (Case-Sensitive)

Defined in **frontend** (`miniprogram/pages/commit-create/index.ts`):

```typescript
typeKeys: ['maintenance', 'repair', 'modification']
typeLabels: ['常规保养', '故障维修', '改装升级']
```

| Key | Label (Chinese) | Description |
|-----|-----------------|-------------|
| `maintenance` | 常规保养 | Regular maintenance (oil change, filter, inspection) |
| `repair` | 故障维修 | Repair work (brake fix, transmission, engine) |
| `modification` | 改装升级 | Upgrades/customizations (suspension, wheels, tuning) |

**Note**: Backend accepts ANY string value for `type` (no enum validation). Frontend picker restricts to 3 options, but API doesn't enforce.

---

## 4. TIMESTAMP FORMAT & HANDLING

### Storage Format
- **Stored as**: `float` (milliseconds since Unix epoch)
- **Example**: `1706333127000` (2024-01-27 10:35:27 UTC)
- **Default value**: Generated via `datetime.now().timestamp() * 1000`

### Frontend Display Conversion
1. **Raw API response**: `"timestamp": 1706333127000`
2. **Conversion in TypeScript** (`pages/repo-detail/index.ts`, line 36):
   ```typescript
   const formatDate = (ts: number) => ts ? new Date(ts).toISOString().split('T')[0] : '--'
   // Result: "2026-01-27" (YYYY-MM-DD)
   ```
3. **Full datetime** (`utils/util.ts`):
   ```typescript
   formatTime(new Date(commit.timestamp))
   // Result: "2026/01/27 10:35:27"
   ```

### Timeline Display
- Commits sorted **descending by timestamp** (newest first, line 94 `routes.py`)
- Formatted as: `"2026/01/27 10:35:27"` in detail page

---

## 5. CURRENT API ENDPOINTS

### GET `/commits` - List Commits for Vehicle

**Endpoint**: `GET /commits?repo_id={repoId}`

**Query Parameters**:
```
repo_id: str (required) - Vehicle ID
```

**Response**: `List[Commit]` (sorted by timestamp DESC)

**Current Query Capabilities**:
- ✅ Filter by `repo_id` (required)
- ✅ Sort by `timestamp` (descending, hardcoded)
- ❌ No other filters (type, mileage range, date range, cost)
- ❌ No pagination
- ❌ No search in title/message

**Frontend call** (`services/api.ts`, line 59):
```typescript
export const getCommits = (repoId: string) => {
    return request(`/commits?repo_id=${repoId}`, 'GET');
};
```

---

### GET `/commits/{commit_id}` - Get Single Commit Detail

**Endpoint**: `GET /commits/{commit_id}`

**Path Parameters**:
```
commit_id: str - MongoDB ObjectId
```

**Response**: `Commit` (single record)

**Error Handling**:
- Returns `400` if ID format invalid
- Returns `404` if not found

---

### POST `/commits` - Create Commit

**Endpoint**: `POST /commits`

**Request Body**:
```json
{
  "repo_id": "objectid_string",
  "title": "更换机油",
  "message": "使用壳牌全合成机油...",
  "mileage": 50000,
  "type": "maintenance",
  "cost": {
    "parts": 150,
    "labor": 80,
    "currency": "CNY"
  },
  "closes_issues": ["issueId1", "issueId2"]
}
```

**Auto-Behaviors on Create**:
1. Sets `timestamp` to current time (if not provided)
2. Updates repo `current_mileage` and `current_head` (only if new mileage > current)
3. Closes specified issues via `closes_issues` array
4. Updates issue `priority` → "high" if mileage ≥ `due_mileage`

---

### GET `/repos/{repo_id}/stats` - Aggregated Statistics

**Endpoint**: `GET /repos/{repo_id}/stats`

**Response**:
```json
{
  "total_cost": 5230,
  "total_mileage": 120000,
  "cost_per_km": 0.044,
  "composition": [
    {"name": "maintenance", "value": 2100},
    {"name": "repair", "value": 1800},
    {"name": "modification", "value": 1330}
  ]
}
```

**Aggregation Pipeline** (lines 225-265):
- Sums `cost.parts + cost.labor` by type
- Supports pie chart visualization
- Includes `cost_per_km` calculation

---

## 6. SEARCHABLE & FILTERABLE FIELDS

### Searchable (Full-Text / Keyword Match)
- ✅ `title` - Maintenance description
- ✅ `message` - Detailed notes
- ✅ `type` - Category
- ✅ `repo_id` - Vehicle reference

### Filterable (Exact/Range Match)
- ✅ `repo_id` - Vehicle ID (required)
- ✅ `type` - Category (enum)
- ✅ `mileage` - Range queries (min/max)
- ✅ `timestamp` - Date range (before/after)
- ✅ `cost.parts` - Parts cost range
- ✅ `cost.labor` - Labor cost range
- ✅ `closes_issues` - Has issue references

### Not Directly Searchable (Yet)
- ❌ `id` - ObjectId comparison only
- ❌ `cost.currency` - Always CNY

---

## 7. FRONTEND INTEGRATION POINTS

### Display in Timeline (`pages/repo-detail/index.ts`, lines 90-98)

```typescript
const formattedCommits = (commits as any[]).map(c => ({
  ...c,
  date: formatTime(new Date(c.timestamp))
}))
```

**Rendered fields** in WXML (`pages/repo-detail/index.wxml`, lines 87-92):
- `item.title` - Main heading
- `item.mileage` - Odometer (km)
- `item._id` - Commit hash/ID
- `item.date` - Formatted timestamp

### Display in Detail Page (`pages/commit-detail/index.wxml`)

**Fields shown**:
- Line 6: `commit.title`
- Line 7: `commit.type` (as tag)
- Line 12: `commit._id` (monospace)
- Line 17: `commit.mileage` (km)
- Line 22: `commit.date` (formatted)
- Line 29: `commit.message` (or "无详细描述")
- Lines 35-43: `commit.cost.parts`, `commit.cost.labor`, total (¥)

---

## 8. DATABASE STORAGE (MongoDB)

### Collection: `commits`

**Sample Document**:
```json
{
  "_id": ObjectId("67950a1c2b6e4a1234567890"),
  "repo_id": "67950a1b2b6e4a0987654321",
  "title": "更换机油和滤芯",
  "message": "使用壳牌Helix Ultra 5W-30全合成机油，更换原厂机油滤芯",
  "mileage": 50000,
  "type": "maintenance",
  "cost": {
    "parts": 150.0,
    "labor": 80.0,
    "currency": "CNY"
  },
  "closes_issues": ["67950a1b2b6e4a3456789abc"],
  "timestamp": 1706333127000
}
```

### Indexes (Not Explicitly Defined - Recommendations)

For search/filter/export optimization, add:
```
db.commits.createIndex({ "repo_id": 1, "timestamp": -1 })
db.commits.createIndex({ "repo_id": 1, "type": 1 })
db.commits.createIndex({ "repo_id": 1, "mileage": 1 })
db.commits.createIndex({ "title": "text", "message": "text" })
```

---

## 9. EXPORT DATA STRUCTURE

### Current Support
- ❌ No export endpoint (custom implementation needed)

### Recommended Export Formats

#### CSV Format
```csv
ID,标题,类型,里程(km),日期,配件费,工时费,总计,备注
67950a1c,更换机油,常规保养,50000,2026-01-27,150,80,230,新机油...
```

#### JSON Format
```json
{
  "vehicle": {
    "name": "特斯拉 Model 3",
    "vin": "ABC123XYZ",
    "mileage": 120000,
    "export_date": "2026-01-27"
  },
  "commits": [
    {
      "id": "67950a1c",
      "title": "更换机油",
      "type": "maintenance",
      "mileage": 50000,
      "date": "2026-01-27",
      "cost_total": 230
    }
  ],
  "summary": {
    "total_records": 45,
    "total_cost": 5230,
    "cost_per_km": 0.044
  }
}
```

---

## 10. IMPLEMENTATION CONSIDERATIONS

### For Search Feature
1. **Keyword search** in `title` + `message` → needs MongoDB text index
2. **Type filter** → exact match (enum validation on backend)
3. **Mileage range** → `$gte` / `$lte` operators
4. **Date range** → timestamp comparison (milliseconds)

### For Filter Feature
```python
# Example backend query
query = {"repo_id": repo_id}
if type_filter:
    query["type"] = type_filter
if min_mileage:
    query["mileage"] = {"$gte": min_mileage}
if max_mileage:
    query["mileage"] = {"$lte": max_mileage}
if start_date:
    query["timestamp"] = {"$gte": start_date * 1000}
```

### For Export Feature
1. Fetch all commits for vehicle
2. Map Pydantic model → export schema
3. Convert timestamps to ISO format
4. Aggregate cost totals
5. Format as CSV/JSON/Excel

---

## 11. VALIDATION RULES (Implicit)

| Field | Rule | Enforced |
|-------|------|----------|
| `repo_id` | Must exist in repos collection | No (app assumes valid) |
| `title` | Non-empty string | Frontend only (min char count) |
| `mileage` | Positive integer | Frontend type="number" |
| `type` | One of enum | Frontend picker; backend accepts all |
| `cost.parts` | Non-negative float | Frontend type="number" |
| `cost.labor` | Non-negative float | Frontend type="number" |
| `closes_issues` | Valid ObjectId strings | No validation |

**Recommendation**: Add Pydantic validators for robust validation.

---

## 12. BACKWARD COMPATIBILITY

### No Breaking Changes If Adding:
- New optional fields in `Commit` model
- New enum values for `type` (with frontend picker update)
- New query parameters to `GET /commits` (default values required)

### Breaking Changes If:
- Removing fields from `Commit`
- Changing `timestamp` storage format
- Changing `type` validation rules retroactively

---

## 13. QUICK REFERENCE: FIELD LOOKUP

### By Search Use Case

**"I want to find commits from June 2025"**
- Filter: `timestamp` (date range)
- Query: `1746086400000` to `1748678399000`

**"Show me all repair work > ¥500"**
- Filter: `type` = "repair", `cost.parts + cost.labor >= 500`
- Query: `{"type": "repair", "cost": {"$gte": ...}}`

**"Find 'spark plug' maintenance records"**
- Search: `title` + `message` (text search)
- Query: `{"$text": {"$search": "spark plug"}}`

**"List modifications between 50k and 80k km"**
- Filter: `type` = "modification", `mileage` range
- Query: `{"type": "modification", "mileage": {"$gte": 50000, "$lte": 80000}}`

---

## Summary Table: API Maturity

| Feature | Status | Notes |
|---------|--------|-------|
| Create Commit | ✅ Complete | Auto HEAD update, issue closing |
| List Commits | ✅ Basic | Only repo_id filter, time sort only |
| Get Detail | ✅ Complete | Single record fetch |
| Filter by Type | ❌ Missing | No backend endpoint param |
| Filter by Mileage | ❌ Missing | No range query support |
| Filter by Date | ❌ Missing | No timestamp range param |
| Search Title/Message | ❌ Missing | No text search endpoint |
| Pagination | ❌ Missing | No limit/offset params |
| Export | ❌ Missing | No export endpoint |
| Stats/Aggregation | ✅ Partial | Only by `type` composition |

